<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareTech</title>
    <link rel="stylesheet" href="../css/dashboardVo.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/modais/modalDeslogar.css">
    <link rel="icon" href="../assets/icon/icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/session.js"></script>
    <script src="../js/scriptDash.js"></script>
    <script src="../js/modais/modalDeslogar.js" defer></script>
</head>

<body onload="buscarKpis()">
    <div class="container-global">
        <div class="box-menu">
            <div class="logomarca">
                <img src="../assets/imgs/logoBrancoDash.png" alt="logoCareTech">
            </div>

            <div class="container-menu">
                <div class="content-menu">
                    <nav class="menu">
                        <ul>
                            <li class="item-menu">
                                <div class="caixa-cor-aqui">
                                    <a href="..\dashboard\dashboardVo.html">
                                        <span class="icon"><i class="bi bi-columns-gap"></i></span>
                                        <span class="txt-link-aqui">Visão geral</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\dashboard.html">
                                        <span class="icon"><i class="bi bi-graph-up"></i></span>
                                        <span class="txt-link">Visão detalhada</span>
                                    </a>
                                </div>
                            </li>

                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\usuarios.html">
                                        <span class="icon"><i class="bi bi-person-fill"></i></span>
                                        <span class="txt-link">Usuários</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\bloqueio.html">
                                        <span class="icon"><i class="bi bi-ban"></i></span>
                                        <span class="txt-link">Bloqueio de sites</span>
                                    </a>
                                </div>
                            </li>


                        </ul>

                        <div class="box-deslogar">
                            <div class="item-menu-deslogar" onclick="abrirModalDeslogar()">
                                <span class="icon"><i class="bi bi-box-arrow-right"></i></span>
                                <span class="txt-link">
                                    <span>Deslogar</span>
                                </span>
                            </div>
                        </div>
                    </nav>

                </div>


            </div>


        </div>

        <div class="caixa-container">
            <div class="container">

                <div class="all-content">

                    <div class="div-titulos">
                        <div class="box-title-content">
                            <span>VISÃO GERAL DAS MÁQUINAS</span>
                        </div>

                        <div class="box-title-acesso-visao">
                            <span> <a href="../dashboard/dashboard.html"> ACESSO À VISÃO DETALHADA </a> </span>
                            <div class="icon-acesso-visao">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </div>
                    </div>

                    <div class="container-one">

                        <div class="container-kpis">
                            <div class="row">

                                <div class="box">
                                    <div class="box-title">
                                        <span>POSSIBILIDADE DE TRAVAMENTO HOJE</span>
                                    </div>

                                    <div class="box-number">
                                        <p id="possibilida_travamento_text">0</p>
                                    </div>

                                    <div class="box-type">
                                        <span>(quantidade)</span>
                                    </div>
                                </div>

                                <div class="box">
                                    <div class="box-title">
                                        <span>LOGIN FORA DO HORÁRIO ESPERADO NESSA SEMANA</span>
                                    </div>

                                    <div class="box-number" id="loginAtrasado">
                                        0
                                    </div>

                                    <div class="box-type">
                                        <span>(quantidade)</span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="box">
                                    <div class="box-title">
                                        <span>MÁQUINAS QUE VÃO ATINGIR LIMITE DE DISCO NO PRÓXIMO MÊS</span>
                                    </div>

                                    <div class="box-number">
                                        <div id="discosProximoLimite">0</div>
                                    </div>

                                    <div class="box-type">
                                        <span>(quantidade)</span>
                                    </div>
                                </div>

                                <div class="box">
                                    <div class="box-title">
                                        <span>
                                            EM ESTADO CRÍTICO AGORA
                                        </span>
                                    </div>


                                <div class="box-number">
                                    <p id="estado_critico_hoje">0</p>
                                </div>


                                    <div class="box-type">
                                        <span>(quantidade)</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="container-tabela">

                            <div class="box-chart">
                                <div class="chart">
                                    <div id="chart1">
                                        <div id="tabelaDisco">
                                            <div class="titulo-chart-table-disco">
                                                <span>PRÓXIMO AO LIMITE DE DISCO</span>
                                            </div>
                                            <div class="graficoT">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>ESTAÇÃO</th>
                                                            <th>USO DISCO</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="tabelaCpuCritico">

                                                    </tbody>
                                                </table>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="container-two">
                    <div class="box-chart-two">
                        <div class="chart-two">
                            <div class="titulo-chart-two">
                                <span>LOGIN FORA DO HORÁRIO ESPERADO NESSA SEMANA</span>
                            </div>
                            <div class="container-grafico-chart-two">
                                <div>
                                    <canvas id="graficoAtrasados" style="height: 90%; width: 30vw;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="box-chart-two">
                        <div class="chart-three">
                            <div class="titulo-chart-table">
                                <span>EM ESTADO CRÍTICO AGORA</span>
                            </div>
                            <div class="graficoT">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>NOME DA MÁQUINA</th>
                                            <th>RAM</th>
                                            <th>CPU</th>
                                            <th>DISCO</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comp_estado_critico_hoje_table"></tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<div class="modalDeslogar" id="deslogarModal">
    <div class="modal-content-deslogar">
        <span class="closeDeslogar">&times;</span>

        <div class="modal-titulo-deslogar">
            <span> <i class="bi bi-box-arrow-right"></i></span>
            <h2>DESLOGAR DA CONTA</h2>
        </div>

        <div class="modal-mensagem-deslogar">
            <p>Tem certeza que deseja encerrar sua sessão?</p>
        </div>

        <div class="modal-botao-deslogar">
            <button id="confirmarDeslogar"> <a onclick="sairConta()">DESLOGAR SESSÃO</a></button>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    validarSessao();
    const idEmpresa = sessionStorage.FK_EMPRESA;
    const maquinasEmpresa = []



    function buscarKpis() {
        fetch(`/dashboard/buscarMaquinas/${sessionStorage.FK_EMPRESA}`, { cache: 'no-store' }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    for (let i = 0; i < resposta.length; i++) {
                        maquinasEmpresa.push(resposta[i].id_computador)
                    }
                    console.log("Vetor de ids da empresa:")

                    console.log("Maquinas empresa: ")

                    console.log(maquinasEmpresa)
                    loginForaDoHorario()
                    let maquinasCpuLimite = 0;
                    for (let i = 0; i < maquinasEmpresa.length; i++) {

                        fetch(`/dashboard/buscarUsoDiscoMaquina/${maquinasEmpresa[i]}`, { cache: 'no-store' }).then(function (resposta) {
                            if (resposta.ok) {
                                resposta.json().then(function (resposta) {

                                    if (resposta[0].uso_percentua > 0.9) {
                                        console.log(resposta[0].uso_percentual + "é menor que 0.9")
                                        maquinasCpuLimite++
                                        console.log(`variável contador: ` + maquinasCpuLimite)
                                        let usoPercentual = (resposta[0].uso_percentual * 100).toFixed(2)
                                        discosProximoLimite.innerHTML = `${maquinasCpuLimite}`
                                        tabelaCpuCritico.innerHTML += `<td>${resposta[0].estacao_de_trabalho}</td>
                                        <td>${usoPercentual}%</td>`
                                    }
                                });
                            }
                        });
                    }
                    setTimeout(possibilidadeTravamentoHoje(maquinasEmpresa), 1500);
                    setTimeout(estadoCriticoHoje(resposta), 3000);
                });
            }
        });


    }
    let atrasoNaSemana = 0;
    let atrasosSegunda = 0;
    let atrasosTerca = 0;
    let atrasosQuarta = 0;
    let atrasosQuinta = 0;
    let atrasosSexta = 0;

    function loginForaDoHorario() {
        atrasoNaSemana = 0;
        atrasosSegunda = 0;
        atrasosTerca = 0;
        atrasosQuinta = 0;
        atrasosSexta = 0;
        let date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Adiciona 1 porque os meses são baseados em zero
        const day = String(date.getDate()).padStart(2, '0');
        //let diaDaSemana = 5
        let diaDaSemana = date.getDay()
        console.log(`Hoje é ${diaDaSemana} dia ${year}-${month}-${day}`)

        const diaBusca = []
        const oneDayMilliseconds = 1000 * 60 * 60 * 24;

        if (diaDaSemana != 0 && diaDaSemana != 6) {
            for (let i = 0; i < diaDaSemana; i++) {
                let dataHoje = new Date();
                let dataMenosI = dataHoje - i * oneDayMilliseconds;
                const dataAnterior = new Date(dataMenosI)
                console.log(dataAnterior)
                let diaFormatado = `${dataAnterior.getFullYear()}-${String(dataAnterior.getMonth() + 1).padStart(2, '0')}-${String(dataAnterior.getDate()).padStart(2, '0')}`
                diaBusca.push(diaFormatado)
            }
            console.log(diaBusca)
            const atrasosPorDiaSemana = []
            console.log("Maquinas Empresa: " + maquinasEmpresa.length)
            for (let i = 0; i < maquinasEmpresa.length; i++) {
                for (let y = 0; y < diaBusca.length; y++) {
                    fetch(`/dashboard/buscarPrimeiroInsert/${maquinasEmpresa[i]}/${diaBusca[y]}`, { cache: 'no-store' }).then(function (resposta) {
                        if (resposta.ok) {
                            resposta.json().then(function (resposta) {
                                console.log(resposta)
                                const dataHoraBanco = resposta[0].horario;

                                // Converta a string para um objeto Date
                                const dataHora = new Date(dataHoraBanco);
                                const diaSemanabanco = dataHora.getDay();
                                // Extraia horas e minutos
                                const horas = dataHora.getHours();
                                const minutos = dataHora.getMinutes();
                                console.log(`Horas: ${horas}, Minutos: ${minutos}`);
                                if(diaSemanabanco != 0 && diaSemanabanco!=6){
                                    if (horas > 8 || horas == 8 && minutos > 0) {
    
                                        console.log("Estou atrasado")
                                        console.log("Dia da semana: " + diaSemanabanco)
                                        if (diaSemanabanco == 1) {
                                            atrasosSegunda++
                                            console.log("Atrasos segunda: " + atrasosSegunda)
                                        } else if (diaSemanabanco == 2) {
                                            atrasosTerca++
                                        } else if (diaSemanabanco == 3) {
                                            atrasosQuarta++
                                        } else if (diaSemanabanco == 4) {
                                            atrasosQuinta++
                                        } else if (diaSemanabanco == 5) {
                                            atrasosSexta++
                                        }
                                        atrasoNaSemana++
                                        loginAtrasado.innerHTML = `${atrasoNaSemana}`
                                        graficoAtrasados.config.data.datasets[0].data = [atrasosSegunda, atrasosTerca, atrasosQuarta, atrasosQuinta, atrasosSexta]
                                        graficoAtrasados.update()
                                    }

                                }

                            });
                        }
                    });

                }


            }

        }
        console.log("Estou no final da função")
    }

    const dataAtrasos = {
        labels: ["Segunda-Feira", "Terça-Feira", "Quarta-Feira", "Quinta-Feira", "Sexta-Feira"],
        datasets: [{
            label: '',
            data: [],
            backgroundColor: [
                'rgb(255, 99, 132)',
            ],
            hoverOffset: 4
        }]
    }

    const configAtrasos = {
        type: 'bar',
        data: dataAtrasos,
        options: {
            scales: {
                x: {
                    grid: {
                        display: false // Remove a grade do eixo X
                    }
                },
                y: {
                    grid: {
                        display: false, // Remove a grade do eixo Y
                    },
                    max: 20
                }
            },
            plugins: {
                legend: {
                    display: false // Desabilita a exibição da legenda
                }
            }
        }
    };

    function possibilidadeTravamentoHoje(listaMaquinas) {
        const computadoresVerificados = [];
        let possibilidaText = document.getElementById('possibilida_travamento_text');

        listaMaquinas.forEach(idMaquina => {
            fetch(`/dashboard/possibilidadeTravamentoHojeRam/${idMaquina}`, { cache: 'no-store' }).then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        resposta.forEach(dados => {
                            const usoPorcentagem = (dados.uso_capacidade * 100) / dados.capacidade_total;
                            if (!computadoresVerificados.includes(idMaquina) && usoPorcentagem > 70) {
                                computadoresVerificados.push(idMaquina);
                            }
                        });
                    });
                }
            });


            fetch(`/dashboard/possibilidadeTravamentoHojeCpu/${idMaquina}`, { cache: 'no-store' }).then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        resposta.forEach(dados => {
                            if (!computadoresVerificados.includes(idMaquina) && dados.uso_capacidade > 70) {
                                computadoresVerificados.push(idMaquina);
                            }
                            possibilidaText.innerHTML = computadoresVerificados.length;
                        });
                    });
                }
            });
        })

    }


    function estadoCriticoHoje(listaMaquinas){
        const listaMaquinasVerificadas = [];

        listaMaquinas.forEach(maquina => {
            const tabelaCriticos = document.getElementById("comp_estado_critico_hoje_table");
            let idCedula = document.getElementById(`cedula${maquina.id_computador}`);
            let usoRamDaVez = 0;
            let usoCpuDaVez = 0;
            let usoDiscoDaVez = 0;
            let qtdComputadoresCriticos = 0;

            
            fetch(`/dashboard/estadoCriticoHojeRam/${maquina.id_computador}`, { cache: 'no-store' }).then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        resposta.forEach(dados => {
                            usoRamDaVez = dados.uso_porcento;
                            
                            if(usoRamDaVez > 90){
                                if(idCedula == null){
                                    qtdComputadoresCriticos++;
                                    document.getElementById('estado_critico_hoje').innerHTML = qtdComputadoresCriticos;

                                    tabelaCriticos.innerHTML += `
                                        <tr id="cedula${maquina.id_computador}">
                                            <td>${maquina.estacao_de_trabalho}</td>
                                            <td id="ram${maquina.id_computador}">${usoRamDaVez.toFixed(2)}%</td>
                                            <td id="cpu${maquina.id_computador}">0%</td>
                                            <td id="disco${maquina.id_computador}">0%</td>
                                        </tr>
                                    `;

                                    idCedula = document.getElementById(`cedula${maquina.id_computador}`);
                                } else {
                                    const idColuna = document.getElementById(`ram${maquina.id_computador}`);
                                    if(idColuna.innerHTML == "0%") idColuna.innerHTML = `${usoRamDaVez.toFixed(2)}%`;
                                }
                            }
                        });
                    });
                }
            });

            fetch(`/dashboard/estadoCriticoHojeCpu/${maquina.id_computador}`, { cache: 'no-store' }).then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        resposta.forEach(dados => {
                            usoCpuDaVez = dados.uso_porcento;
                            
                            if(usoCpuDaVez > 90){
                                if(idCedula == null){
                                    qtdComputadoresCriticos++;
                                    document.getElementById('estado_critico_hoje').innerHTML = qtdComputadoresCriticos;
                                    tabelaCriticos.innerHTML += `
                                        <tr id="cedula${maquina.id_computador}">
                                            <td>${maquina.estacao_de_trabalho}</td>
                                            <td id="ram${maquina.id_computador}">0%</td>
                                            <td id="cpu${maquina.id_computador}">${usoCpuDaVez.toFixed(2)}%</td>
                                            <td id="disco${maquina.id_computador}">0%</td>
                                        </tr>
                                    `;

                                    idCedula = document.getElementById(`cedula${maquina.id_computador}`);
                                } else {
                                    const idColuna = document.getElementById(`cpu${maquina.id_computador}`);
                                    if(idColuna.innerHTML == "0%") idColuna.innerHTML = `${usoCpuDaVez.toFixed(2)}%`;
                                }
                            }
                        });
                    });
                }
            });

            fetch(`/dashboard/estadoCriticoHojeDisco/${maquina.id_computador}`, { cache: 'no-store' }).then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        resposta.forEach(dados => {
                            usoDiscoDaVez = dados.uso_porcento;
                            
                            if(usoDiscoDaVez > 90){
                                if(idCedula == null){
                                    qtdComputadoresCriticos++;
                                    document.getElementById('estado_critico_hoje').innerHTML = qtdComputadoresCriticos;
                                    tabelaCriticos.innerHTML += `
                                        <tr id="${maquina.id_computador}">
                                            <td>${maquina.estacao_de_trabalho}</td>
                                            <td id="ram${maquina.id_computador}">0%</td>
                                            <td id="cpu${maquina.id_computador}">0%</td>
                                            <td id="disco${maquina.id_computador}">${usoDiscoDaVez.toFixed(2)}%</td>
                                        </tr>
                                    `;

                                    idCedula = document.getElementById(`cedula${maquina.id_computador}`);
                                } else {
                                    const idColuna = document.getElementById(`disco${maquina.id_computador}`);
                                    if(idColuna.innerHTML == "0%") idColuna.innerHTML = `${usoDiscoDaVez.toFixed(2)}%`;
                                }
                            } else {
                                let idCedula1 = document.getElementById(`cedula${maquina.id_computador}`);

                                if(idCedula1 != null){
                                    const idColunaRam = document.getElementById(`ram${maquina.id_computador}`);
                                    const idColunaCpu = document.getElementById(`cpu${maquina.id_computador}`);
                                    const idColunaDisco = document.getElementById(`disco${maquina.id_computador}`);

                                    if(idColunaRam.innerHTML == "0%") idColunaRam.innerHTML = `${usoRamDaVez.toFixed(2)}%`;
                                    if(idColunaCpu.innerHTML == "0%") idColunaCpu.innerHTML = `${usoCpuDaVez.toFixed(2)}%`;
                                    if(idColunaDisco.innerHTML == "0%") idColunaDisco.innerHTML = `${usoDiscoDaVez.toFixed(2)}%`;
                                }
                            }
                        });
                    });
                }
            });
        });
    }


</script>
  
<script>
    const graficoAtrasados = new Chart(
        document.getElementById('graficoAtrasados'),
        configAtrasos
    )
</script>
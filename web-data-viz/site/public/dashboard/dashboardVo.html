<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareTech</title>
    <link rel="stylesheet" href="../css/dashboardVo.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/modais/modalDeslogar.css">
    <link rel="icon" href="../assets/icon/icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/session.js"></script>
    <script src="../js/scriptDash.js"></script>
    <script src="../js/modais/modalDeslogar.js" defer></script>
</head>

<body onload="buscarKpis()">
    <div class="container-global">
        <div class="box-menu">
            <div class="logomarca">
                <img src="../assets/imgs/logoBrancoDash.png" alt="logoCareTech">
            </div>

            <div class="container-menu">
                <div class="content-menu">
                    <nav class="menu">
                        <ul>
                            <li class="item-menu">
                                <div class="caixa-cor-aqui">
                                    <a href="..\dashboard\dashboardVo.html">
                                        <span class="icon"><i class="bi bi-columns-gap"></i></span>
                                        <span class="txt-link-aqui">Visão geral</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\dashboard.html">
                                        <span class="icon"><i class="bi bi-graph-up"></i></span>
                                        <span class="txt-link">Visão detalhada</span>
                                    </a>
                                </div>
                            </li>

                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\usuarios.html">
                                        <span class="icon"><i class="bi bi-person-fill"></i></span>
                                        <span class="txt-link">Usuários</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\bloqueio.html">
                                        <span class="icon"><i class="bi bi-ban"></i></span>
                                        <span class="txt-link">Bloqueio de sites</span>
                                    </a>
                                </div>
                            </li>


                        </ul>

                        <div class="box-deslogar">
                            <div class="item-menu-deslogar" onclick="abrirModalDeslogar()">
                                <span class="icon"><i class="bi bi-box-arrow-right"></i></span>
                                <span class="txt-link">
                                    <span>Deslogar</span>
                                </span>
                            </div>
                        </div>
                    </nav>

                </div>


            </div>


        </div>

        <div class="caixa-container">
            <div class="container">

                <div class="all-content">

                    <div class="div-titulos">
                        <div class="box-title-content">
                            <span>VISÃO GERAL DAS MÁQUINAS</span>
                        </div>

                        <div class="box-title-acesso-visao">
                            <span> <a href="../dashboard/dashboard.html"> ACESSO À VISÃO DETALHADA </a>  </span>
                            <div class="icon-acesso-visao">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </div>
                    </div>

                    <div class="container-one">
                        <div class="row">

                            <div class="box">
                                <div class="box-title">
                                    <span>POSSIBILIDADE DE TRAVAMENTO HOJE</span>
                                </div>

                                <div class="box-number">
                                    <p>2</p>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                            <div class="box">
                                <div class="box-title">
                                    <span>LOGIN FORA DO HORÁRIO ESPERADO NA ÚLTIMA SEMANA</span>
                                </div>

                                <div class="box-number">
                                    <p>10</p>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                            <div class="box">
                                <div class="box-title">
                                    <span>MÁQUINAS QUE VÃO ATINGIR LIMITE DE DISCO NO PRÓXIMO MÊS</span>
                                </div>

                                <div class="box-number">
                                    <div id="discosProximoLimite">0</div>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                            <div class="box">
                                <div class="box-title">
                                    <span>
                                        EM ESTADO CRÍTICO HOJE
                                    </span>
                                </div>

                                <div class="box-number">
                                    <p id="estado_critico_hoje">10</p>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                        </div>

                        <div class="box-chart">
                            <div class="chart">
                                <div id="chart1">
                                    <div id="tabelaDisco">
                                        <div class="titulo-chart-table">
                                            <span>PRÓXIMO AO LIMITE DE DISCO</span>
                                        </div>
                                        <div class="graficoT">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>ESTAÇÃO</th>
                                                        <th>USO CPU</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tabelaCpuCritico">
                                                    
                                                </tbody>
                                            </table>
            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container-two">
                    <div class="box-chart-two">
                        <div class="chart-two">
                            
                        </div>
                    </div>
                    <div class="box-chart-two">
                        <div class="chart-three">
                            <div class="titulo-chart-table">
                                <span>EM ESTADO CRÍTICO HOJE</span>
                            </div>
                            <div class="graficoT">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nº MÁQUINA</th>
                                            <th>RAM</th>
                                            <th>CPU</th>
                                            <th>DISCO</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comp_estado_critico_hoje_table"></tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<div class="modalDeslogar" id="deslogarModal">
    <div class="modal-content-deslogar">
        <span class="closeDeslogar">&times;</span>

        <div class="modal-titulo-deslogar">
            <span> <i class="bi bi-box-arrow-right"></i></span>
            <h2>DESLOGAR DA CONTA</h2>
        </div>

        <div class="modal-mensagem-deslogar">
            <p>Tem certeza que deseja encerrar sua sessão?</p>
        </div>

        <div class="modal-botao-deslogar">
            <button id="confirmarDeslogar"> <a onclick="sairConta()">DESLOGAR SESSÃO</a></button>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    validarSessao();
    const idEmpresa = sessionStorage.FK_EMPRESA;
    const maquinasEmpresa = []
    

    function buscarKpis(){
        fetch(`/dashboard/buscarMaquinas/${sessionStorage.FK_EMPRESA}`, { cache: 'no-store' }).then(function (resposta) {
            if(resposta.ok){
                resposta.json().then(function (resposta){
                    
                    console.log("buscando qtd de máquinas")
                    numMaquinas = resposta.length;
                    console.log(resposta)
                    console.log("Numero de maquinas")
                    console.log(numMaquinas)
                    for(let i = 0; i < resposta.length; i++){
                        maquinasEmpresa.push(resposta[i].id_computador)
                    }
                    console.log("Vetor de ids da empresa:")
                    console.log(maquinasEmpresa)
                    let maquinasCpuLimite = 0;
                    for(let i=0; i<maquinasEmpresa.length;i++){
                        console.log("Entrei no for")
                        fetch(`/dashboard/buscarUsoDiscoMaquina/${maquinasEmpresa[i]}`, { cache: 'no-store' }).then(function (resposta) {
                            if(resposta.ok){
                                resposta.json().then(function (resposta){
                                    console.log(`Máquina ${i}`)
                                    console.log(resposta[0].uso_percentual)
                                    if(resposta[0].uso_percentual>0.9){
                                        console.log(resposta[0].uso_percentual + "é menor que 0.9")
                                        maquinasCpuLimite++
                                        console.log(`variável contador: ` + maquinasCpuLimite)
                                        let usoPercentual = (resposta[0].uso_percentual*100).toFixed(2)
                                        discosProximoLimite.innerHTML = `${maquinasCpuLimite}`
                                        tabelaCpuCritico.innerHTML += `<td>${resposta[0].estacao_de_trabalho}</td>
                                        <td>${usoPercentual}%</td>`
                                    }
                                });
                            }
                        });
                    }
                    
                });
            }
        });



    }

        

    function getWeekdays() {
        const currentDate = new Date();
        const dayOfWeek = currentDate.getDay(); // 0 (Sunday) to 6 (Saturday)
        const dayDifference = (dayOfWeek + 6) % 7; // Calculate days since Monday
        const monday = new Date(currentDate);
        monday.setDate(currentDate.getDate() - dayDifference);

        const weekdays = [];
        for (let i = 0; i < 5; i++) { // Only loop for Monday to Friday
            const day = new Date(monday);
            day.setDate(monday.getDate() + i);
            weekdays.push(day);
        }

        return weekdays;
    }

    function isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
            date1.getMonth() === date2.getMonth() &&
            date1.getDate() === date2.getDate();
    }


</script>
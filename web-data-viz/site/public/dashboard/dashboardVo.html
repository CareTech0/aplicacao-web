<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareTech</title>
    <link rel="stylesheet" href="../css/dashboardVo.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/modais/modalDeslogar.css">
    <link rel="icon" href="../assets/icon/icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="../js/session.js"></script>
    <script src="../js/scriptDash.js"></script>
    <script src="../js/modais/modalDeslogar.js" defer></script>
</head>

<body>
    <div class="container-global">
        <div class="box-menu">
            <div class="logomarca">
                <img src="../assets/imgs/logoBrancoDash.png" alt="logoCareTech">
            </div>

            <div class="container-menu">
                <div class="content-menu">
                    <nav class="menu">
                        <ul>
                            <li class="item-menu">
                                <div class="caixa-cor-aqui">
                                    <a href="..\dashboard\dashboardVo.html">
                                        <span class="icon"><i class="bi bi-columns-gap"></i></span>
                                        <span class="txt-link-aqui">Visão geral</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\dashboard.html">
                                        <span class="icon"><i class="bi bi-graph-up"></i></span>
                                        <span class="txt-link">Visão detalhada</span>
                                    </a>
                                </div>
                            </li>

                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\usuarios.html">
                                        <span class="icon"><i class="bi bi-person-fill"></i></span>
                                        <span class="txt-link">Usuários</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\bloqueio.html">
                                        <span class="icon"><i class="bi bi-ban"></i></span>
                                        <span class="txt-link">Bloqueio de sites</span>
                                    </a>
                                </div>
                            </li>


                        </ul>

                        <div class="box-deslogar">
                            <div class="item-menu-deslogar" onclick="abrirModalDeslogar()">
                                <span class="icon"><i class="bi bi-box-arrow-right"></i></span>
                                <span class="txt-link">
                                    <span>Deslogar</span>
                                </span>
                            </div>
                        </div>
                    </nav>

                </div>


            </div>


        </div>

        <div class="caixa-container">
            <div class="container">

                <div class="all-content">

                    <div class="div-titulos">
                        <div class="box-title-content">
                            <span>VISÃO GERAL DAS MÁQUINAS</span>
                        </div>

                        <div class="box-title-acesso-visao">
                            <span> <a href="../dashboard/dashboard.html"> ACESSO À VISÃO DETALHADA </a>  </span>
                            <div class="icon-acesso-visao">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </div>
                    </div>

                    <div class="container-one">
                        <div class="row">

                            <div class="box">
                                <div class="box-title">
                                    <span>POSSIBILIDADE DE TRAVAMENTO HOJE</span>
                                </div>

                                <div class="box-number">
                                    <p>2</p>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                            <div class="box">
                                <div class="box-title">
                                    <span>LOGIN FORA DO HORÁRIO ESPERADO NA ÚLTIMA SEMANA</span>
                                </div>

                                <div class="box-number">
                                    <p>10</p>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                            <div class="box">
                                <div class="box-title">
                                    <span>COM PROBLEMAS RECORRENTES NA SEMANA</span>
                                </div>

                                <div class="box-number">
                                    <p id="total_problemas_semana">0</p>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                            <div class="box">
                                <div class="box-title">
                                    <span>
                                        EM ESTADO CRÍTICO HOJE
                                    </span>
                                </div>

                                <div class="box-number">
                                    <p id="estado_critico_hoje">10</p>
                                </div>

                                <div class="box-type">
                                    <span>(quantidade)</span>
                                </div>
                            </div>

                        </div>

                        <div class="box-chart">
                            <div class="chart">
                                <div id="chart1">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container-two">
                    <div class="box-chart-two">
                        <div class="chart-two">
                            <div id="chart2">

                            </div>
                        </div>
                    </div>
                    <div class="box-chart-two">
                        <div class="chart-three">
                            <div class="titulo-chart-table">
                                <span>EM ESTADO CRÍTICO HOJE</span>
                            </div>
                            <div class="graficoT">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nº MÁQUINA</th>
                                            <th>RAM</th>
                                            <th>CPU</th>
                                            <th>DISCO</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comp_estado_critico_hoje_table"></tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<div class="modalDeslogar" id="deslogarModal">
    <div class="modal-content-deslogar">
        <span class="closeDeslogar">&times;</span>

        <div class="modal-titulo-deslogar">
            <span> <i class="bi bi-box-arrow-right"></i></span>
            <h2>DESLOGAR DA CONTA</h2>
        </div>

        <div class="modal-mensagem-deslogar">
            <p>Tem certeza que deseja encerrar sua sessão?</p>
        </div>

        <div class="modal-botao-deslogar">
            <button id="confirmarDeslogar"> <a onclick="sairConta()">DESLOGAR SESSÃO</a></button>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    validarSessao();
    document.addEventListener("DOMContentLoaded", function () {
        google.charts.load("current", { packages: ["corechart"] });
        google.charts.setOnLoadCallback(drawChart1);
        google.charts.setOnLoadCallback(drawChart2);

        function drawChart1() {
            var data = google.visualization.arrayToDataTable([
                ["Data", "Quantidade"],
                ["Segunda", 10],
                ["Terça", 35],
                ["Quarta", 10],
                ["Quinta", 30],
                ["Sexta", 25],
            ]);

            var options = {
                title: "MÁQUINAS COM PROBLEMAS RECORRENTES NA SEMANA",
                width: "100%",
                height: "100%",
                legend: { position: "bottom" },
            };

            var chart = new google.visualization.LineChart(
                document.getElementById("chart1")
            );

            chart.draw(data, options);
        }

        function drawChart2() {
            console.log("aaaaaaaaa")
            var data = google.visualization.arrayToDataTable([
                ["Dia", "Percentual"],
                ["Segunda", 20],
                ["Terça", 35],
                ["Quarta", 45],
                ["Quinta", 60],
            ]);

            var options = {
                title: "LOGIN FORA DO HORÁRIO ESPERADO NA ÚLTIMA SEMANA",
                legend: { position: "none" },
                width: "100%",
                height: "100%",
            };

            var chart = new google.visualization.BarChart(
                document.getElementById("chart2")
            );

            chart.draw(data, options);
        }

    });

    function buscarProblemasSemana(dadosMaquina){
        let qtdTravamentoSeg = 0;
        let qtdTravamentoTer = 0;
        let qtdTravamentoQua = 0;
        let qtdTravamentoQui = 0;
        let qtdTravamentoSex = 0;

        const weekdays = getWeekdays();
        const monday = weekdays[0];
        const tuesday = weekdays[1];
        const wednesday = weekdays[2];
        const thursday = weekdays[3];
        const friday = weekdays[4];
                            

        dadosMaquina.forEach(maquina => {
            fetch(`/dashboard/buscarProblemasSemana/${maquina.id_computador}`, {cache: 'no-store'}).then(function (resposta) {
                if(resposta.ok){
                    resposta.json().then(function (resposta){
                        resposta.forEach(dados => {
                            const dadosData = new Date(dados.horario);
                            if(isSameDay(dadosData, monday)) {
                                qtdTravamentoSeg++;
                            } else if(isSameDay(dadosData, tuesday)) {
                                qtdTravamentoTer++;
                            } else if(isSameDay(dadosData, wednesday)) {
                                qtdTravamentoQua++;
                            } else if(isSameDay(dadosData, thursday)) {
                                qtdTravamentoQui++;
                            } else if(isSameDay(dadosData, friday)) {
                                qtdTravamentoSex++;
                            }
                        
                             
                        });
                    });
                }
            })
        });

        const textTot = document.getElementById('total_problemas_semana');
                            textTot.innerHTML = qtdTravamentoSeg + qtdTravamentoQui + qtdTravamentoSex + qtdTravamentoTer + qtdTravamentoQua;
    }

    function getWeekdays() {
        const currentDate = new Date();
        const dayOfWeek = currentDate.getDay(); // 0 (Sunday) to 6 (Saturday)
        const dayDifference = (dayOfWeek + 6) % 7; // Calculate days since Monday
        const monday = new Date(currentDate);
        monday.setDate(currentDate.getDate() - dayDifference);

        const weekdays = [];
        for (let i = 0; i < 5; i++) { // Only loop for Monday to Friday
            const day = new Date(monday);
            day.setDate(monday.getDate() + i);
            weekdays.push(day);
        }

        return weekdays;
    }

    function isSameDay(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
            date1.getMonth() === date2.getMonth() &&
            date1.getDate() === date2.getDate();
    }

    // function buscarCriticosDoDia(dadosDaMaquina){
    //     let qtdMaquinasCriticos = 0;
    //     dadosDaMaquina.forEach(maquina => {
    //         fetch(`/dashboard/buscarCriticosDoDia/${maquina.id_computador}`, { cache: 'no-store' }).then(function (resposta) {
    //             if(resposta.ok){
    //                 resposta.json().then(function (resposta){
    //                     resposta.forEach(dados => {
    //                         const tabelaCriticosHoje = document.getElementById('comp_estado_critico_hoje_table');
    //                         const capacidadeTotal = dados.capacidade_total;
    //                         const usoCapacidade = dados.uso_capacidade;
    //                         const nomeHardware = dados.nome_hardware;
    //                         const idHardware = dados.id_hardware

    //                         let usoPorcentagem = 0;
    //                         let tabelaComputador = document.getElementById(maquina.id_computador);

    //                         if(nomeHardware != 'rede'){
    //                             if(nomeHardware == 'disco' || nomeHardware == 'ram') usoPorcentagem = (usoCapacidade * 100) / capacidadeTotal;
    //                             else usoPorcentagem = usoCapacidade;

    //                             if(tabelaComputador == null){
    //                                 if(usoPorcentagem > 10) {
    //                                     qtdMaquinasCriticos++;
    //                                 }   
    //                                 tabelaCriticosHoje.innerHTML += `
    //                                     <tr id="${maquina.id_computador}">
    //                                         <td class="number-maquina"><a>${maquina.id_computador}</a></td>
    //                                         <td id="ram${maquina.id_computador}">---</td>
    //                                         <td id="cpu${maquina.id_computador}">---</td>
    //                                         <td id="disco${maquina.id_computador}">---</td>
    //                                     </tr>
    //                                 `;
    //                                 tabelaComputador = document.getElementById(maquina.id_computador);
    //                             }
    //                         }


    //                         if(tabelaComputador != null){
    //                             if(nomeHardware == "ram"){
    //                                 if(document.getElementById(`ram${maquina.id_computador}`).innerHTML == '---') document.getElementById(`ram${maquina.id_computador}`) = `${usoPorcentagem.toFixed(2)}%`;
    //                             } 
                                
    //                             if(nomeHardware == "cpu"){
    //                                 if(document.getElementById(`cpu${maquina.id_computador}`).innerHTML == '---') document.getElementById(`cpu${maquina.id_computador}`) = `${usoPorcentagem.toFixed(2)}%`;
    //                             } 

    //                             if(nomeHardware == "disco") {
    //                                 if(document.getElementById(`disco${maquina.id_computador}`).innerHTML == '---') document.getElementById(`disco${maquina.id_computador}`).innerHTML = `${usoPorcentagem.toFixed(2)}%`;
    //                             }
    //                         }

    //                     });
    //                 });
    //             }
    //         });
    //     });
    //     document.getElementById('estado_critico_hoje').innerText = qtdMaquinasCriticos;
    // }

</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareTech</title>
    <link rel="stylesheet" href="../css/usuarios.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/modais/modalDeslogar.css">
    <link rel="stylesheet" href="../css/modais/modalUsuarios.css">
    <link rel="icon" href="../assets/icon/icon.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="../js/session.js"></script>
    <script src="../js/modais/modalDeslogar.js" defer></script>
</head>

<body>
    <div class="container-global">
        <div class="box-menu">
            <div class="logomarca">
                <img src="../assets/imgs/logoBrancoDash.png" alt="logoCareTech">
            </div>

            <div class="container-menu">
                <div class="content-menu">
                    <nav class="menu">
                        <ul>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\dashboardVo.html">
                                        <span class="icon"><i class="bi bi-columns-gap"></i></span>
                                        <span class="txt-link">Visão geral</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\dashboard.html">
                                        <span class="icon"><i class="bi bi-graph-up"></i></span>
                                        <span class="txt-link">Visão detalhada</span>
                                    </a>
                                </div>
                            </li>

                            <li class="item-menu">
                                <div class="caixa-cor-aqui">
                                    <a href="..\dashboard\usuarios.html">
                                        <span class="icon"><i class="bi bi-person-fill"></i></span>
                                        <span class="txt-link-aqui">Usuários</span>
                                    </a>
                                </div>
                            </li>
                            <li class="item-menu">
                                <div class="caixa-cor">
                                    <a href="..\dashboard\bloqueio.html">
                                        <span class="icon"><i class="bi bi-ban"></i></span>
                                        <span class="txt-link">Bloqueio de sites</span>
                                    </a>
                                </div>
                            </li>


                        </ul>

                        <div class="box-deslogar">
                            <div class="item-menu-deslogar" onclick="abrirModalDeslogar()">
                                <span class="icon"><i class="bi bi-box-arrow-right"></i></span>
                                <span class="txt-link">
                                    <span>Deslogar</span>
                                </span>
                            </div>
                        </div>
                    </nav>

                </div>


            </div>


        </div>

        <div class="caixa-container">
            <div class="container">

                <div class="container-cadastro">

                    <div class="content-usuarios">
                        <div class="todo-conteudo">

                            <div class="caixa-titulo">
                                <div class="content-titulo-usuarios">

                                    <div class="content-img-usuario">
                                        <img src="../assets/imgs/iconUser.png">
                                    </div>
                                    <div class="titulo-cadastrar-usuarios">

                                        <span>USUÁRIOS</span>
                                        <p>Gerencie seus usuários e permissões aqui.</p>

                                    </div>

                                </div>

                                <div class="botao-cadastrar-usuario">
                                    <span class="icon-cadastrar-user"><i class="bi bi-plus-circle"></i></span>
                                    <span class="txt-cadastrar-usuario">NOVO USUÁRIO</span>
                                </div>
                            </div>
                            <div class="content-visualizar-usuarios">
                                <div class="box-usuarios" id="box_usuarios">
                                    <div class="titulo-box-usuarios">

                                        <div class="tipo-box-usuarios">
                                            <h1>Nome</h1>
                                            <p>Endereço de e-mail</p>
                                        </div>

                                        <div class="perfil-box-usuarios">
                                            <h1>Perfil</h1>
                                        </div>

                                        <div class="perfil-box-usuarios">
                                            <h1>Editar</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
</body>

<!-- Modal Excluir Usuário -->
<div class="modal-excluir" id="deleteModal">
    <div class="modal-content-excluir">
        <span class="close">&times;</span>

        <div class="modal-titulo">
            <span> <i class="bi bi-person-x-fill"></i> </span>
            <h2>DELETAR USUÁRIO</h2>
        </div>

        <div class="modal-mensagem">
            <p>Deletar a conta irá remover todas as informações do nosso banco de dados. Essa ação
                não pode
                ser
                desfeita.</p>
        </div>

        <div class="modal-botao-excluir">
            <button id="confirmDelete">EXCLUIR CONTA </button>
        </div>
    </div>
</div>


<!-- Modal adicionar novo usuário -->
<div class="modal" id="newUserModal">
    <div class="modal-content-novo-usuario">

        <span class="close">&times;</span>

        <div class="modal-titulo-novo-usuario">
            <span class="icon"><i class="bi bi-person-gear"></i></span>
            <h2>ADICIONAR USUÁRIO</h2>
        </div>

        <div class="inputs-modal-novo-usuario">

            <div class="content-input-modal-novo-usuario">
                <span> Nome: </span>
                <input type="text" name="nome" id="ipt_nome">
            </div>

            <div class="content-input-modal-novo-usuario">
                <span> E-mail:</span>
                <input type="text" name="email" id="ipt_email">
            </div>

            <div class="content-input-modal-novo-usuario">
                <span> Senha: </span>
                <input type="password" id="ipt_senha">
            </div>

            <div class="content-input-modal-novo-usuario">
                <span> Confirmar senha:</span>
                <input type="password" id="ipt_repetir_senha">
            </div>


            <div class="content-input-modal-novo-usuario-tooltip">

                <div class="titulo-tipo-acesso">
                    <span> Tipo de acesso:</span>
                </div>

                <div class="box-tooltip">
                    <div class="tooltip-container">
                        <span class="tooltip-icon">i</span>
                        <div class="tooltip-text"><b>Administradores:</b> Têm controle total sobre
                            máquinas,
                            usuários e bloqueio de sites.
                            <br> <br>
                            <b>Usuário comum:</b> Apenas visualização da dashboard.
                        </div>
                    </div>
                </div>

                <div class="content-input-modal">
                    <select name="perfil" id="slct_tipo_user">
                        <option value="administrador">Administrador</option>
                        <option value="usuario">Usuário comum</option>
                    </select>
                </div>
               
            </div>
            <div style="width:100%; align-items: center; display: flex; flex-direction: column; color: red; font-size: 15px;" id="erromensagem"></div>
            <button  class="botao-adicionar" id="save_new_user">SALVAR</button>



        </div>
    </div>
</div>

<!-- modal deslogar -->

<div class="modalDeslogar" id="deslogarModal">
    <div class="modal-content-deslogar">
        <span class="closeDeslogar">&times;</span>
        <div class="modal-titulo-deslogar">
            <span><i class="bi bi-box-arrow-right"></i></span>
            <h2>DESLOGAR DA CONTA</h2>
        </div>
        <div class="modal-mensagem-deslogar">
            <p>Tem certeza que deseja encerrar sua sessão?</p>
        </div>
        <div class="modal-botao-deslogar">
            <button id="confirmarDeslogar" onclick="sairConta()">DESLOGAR SESSÃO</button>
        </div>
    </div>
</div>

<!-- modal editar usuario -->
<div class="modal" id="editModal">
    
</div>

</html>

<script>
   
    buscarUsuarios();
    let menuItem = document.querySelectorAll(".item-menu");

    function selectLink() {
        menuItem.forEach((item) => item.classList.remove("ativo"));
        this.classList.add("ativo");
    }

    menuItem.forEach((item) =>
        item.addEventListener('click', selectLink)
    )

    //  elementos dos modais
    const deleteModal = document.getElementById('deleteModal');
    const newUserModal = document.getElementById('newUserModal');
    const editModal = document.getElementById('editModal');
    const successModal = document.getElementById('successModal');

    //  botões que abrem os modais
    const deleteButtons = document.querySelectorAll('.delete-user');
    const newButton = document.querySelector('.botao-cadastrar-usuario');
    const editButtons = document.querySelectorAll('.edit-user');


    // botões de fechar dos modais
    const closeButtons = document.querySelectorAll('.close');

    //botão para salvar o usário
    const saveUser = document.getElementById('save_new_user');

    // funcoes para abrir os modais
    function abrirDeleteModal() {
        deleteModal.style.display = 'block';
    }

    function abrirNewUserModal() {
        newUserModal.style.display = 'block';
    }

    function abrirSuccessModal() {
        successModal.style.display = 'block';
    }

    // eventos de clique nos botões que abrem os modais
    deleteButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            abrirDeleteModal();
        });
    });


    newButton.addEventListener('click', function () {
        abrirNewUserModal();
    });


    // evento de clique nos botões de fechar dos modais
    closeButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            deleteModal.style.display = 'none';
            newUserModal.style.display = 'none';
            editModal.style.display = 'none';
            successModal.style.display = 'none';
        });
    });

    // Fechar o modal quando clicar fora dele
    window.addEventListener('click', function (event) {
        if (event.target == deleteModal || event.target == newUserModal || event.target == editModal) {
            deleteModal.style.display = 'none';
            newUserModal.style.display = 'none';
            editModal.style.display = 'none';
            newModal.style.display = 'none';

        }
    });

    let qtdUsuarios = 0;

    //Puxar usuários do banco de dados
    function buscarUsuarios() {
        fetch(`/usuario/buscarUsuarios/${sessionStorage.FK_EMPRESA}`, { cache: 'no-store' }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    const boxUsuarios = document.getElementById("box_usuarios");
                    let i = 0;

                    for (; i < resposta.length; i++) {
                        const usuario = resposta[i];
                        let textoToogle = "";

                        if (usuario.tipo_usuario.toLowerCase() === "administrador") {
                            textoToogle = "Têm controle total sobre máquinas, usuários e bloqueio de sites.";
                        } else {
                            textoToogle = "Apenas visualização da dashboard.";
                        }

                        const tipoUsuarioCapitalizado = capitalizarPrimeiraLetra(usuario.tipo_usuario);

                      
                        boxUsuarios.innerHTML += `
                        <div class="conteudo-usuario">
                                        <div class="dados-usuario">
                                            <h1>${usuario.nome}</h1>
                                            <p>${usuario.login_email}</p>
                                        </div>

                                        <div class="perfil-usuario">
                                            <div class="perf-type">
                                                <h1>${tipoUsuarioCapitalizado}</h1>
                                            </div>
                                            <div class="box-tooltip-principal">
                                                <div class="tooltip-container-principal">
                                                    <span class="tooltip-icon-principal">i</span>
                                                    <div class="tooltip-text-principal"><b>${tipoUsuarioCapitalizado}:</b> ${textoToogle}
                                                        
                                                        <br>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>



                                        <div class="opcoes-usuario">
                                            <span class="delete-user" onclick="deletarUsuario(${usuario.id_user})" data-target="#deleteModal"><i
                                                    class="bi bi-trash3"></i></i></span>
                                            <span class="edit-user" onclick="abrirEditModal(${usuario.id_user}, '${usuario.nome}', '${usuario.login_email}', '${usuario.senha}')" data-target="#editModal"><i
                                                    class="bi bi-pencil-square"></i></span>
                                        </div>
                                    </div>
                        `;

                    }
                    qtdUsuarios = i;
                })
            }
        })
            .catch(function (usuario) {
                console.log(`#ERRO: ${resposta}`);
                alert("Erro no banco");
            });
    }

    function capitalizarPrimeiraLetra(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    //Editar Usuário
    function abrirEditModal(id, nome, email, senha){
        editModal.style.display = 'block';
        editModal.innerHTML = `
            <div class="modal-content-editar-usuario">

                <span class="close">&times;</span>

                <div class="modal-titulo-novo-usuario">
                    <span class="icon"><i class="bi bi-person-gear"></i></span>
                    <h2>EDITAR USUÁRIO</h2>
                </div>

                <div class="inputs-modal-novo-usuario">

                    <div class="content-input-modal-novo-usuario">
                        <span> Nome: </span>
                        <input type="text" name="nome" value="${nome}" id="nome_usuario_edit">
                    </div>

                    <div class="content-input-modal-novo-usuario">
                        <span> E-mail:</span>
                        <input type="text" name="email" value="${email}" id="email_usuario_edit">
                    </div>

                    <div class="content-input-modal-novo-usuario">
                        <span> Senha: </span>
                        <input type="password" id="senha_usuario_edit" value="${senha}">
                    </div>

                    <div class="content-input-modal-novo-usuario">
                        <span> Confirmar senha:</span>
                        <input type="password" id="repetirSenha_usuario_edit" value="${senha}">
                    </div>


                    <div class="content-input-modal-novo-usuario-tooltip">

                        <div class="titulo-tipo-acesso">
                            <span> Tipo de acesso:</span>
                        </div>

                        <div class="box-tooltip">
                            <div class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <div class="tooltip-text"><b>Administradores:</b> Têm controle total sobre
                                    máquinas,
                                    usuários e bloqueio de sites.
                                    <br> <br>
                                    <b>Usuário comum:</b> Apenas visualização da dashboard.
                                </div>
                            </div>
                        </div>

                        <div class="content-input-modal" id="1">
                            <select id="perfil_usuario_edit" name="perfil">
                                <option value="administrador">Administrador</option>
                                <option value="usuario">Usuário comum</option>
                            </select>
                        </div>
                        
                        <div id="erroMensagem3"></div>

                    </div>
                    <button class="botao-adicionar" onclick="editarUsuario(${id})">SALVAR</button>
                </div>
            </div>
        `;
    }

    function editarUsuario(id){
        const nome = document.getElementById('nome_usuario_edit').value;
        const email = document.getElementById('email_usuario_edit').value;
        const senha = document.getElementById('senha_usuario_edit').value;
        const repetirSenha = document.getElementById('repetirSenha_usuario_edit').value;
        const tipoUser = document.getElementById('perfil_usuario_edit').value;
        const qtdUsuariosPlano = 10;

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const nomeRegex = /\d/;
        let validacoesCorretas = 5;

        const errorMessage = document.getElementById('erroMensagem3');
        errorMessage.innerHTML = '';

        if (nome == "") {
            errorMessage.innerHTML += '<span>O nome é obrigatório. <br></span>';
            validacoesCorretas--;
        }
           
        if (email == "") {
            errorMessage.innerHTML += '<span>O email é obrigatório.<br></span>';
            validacoesCorretas--;
        } else if (!emailRegex.test(email)) {
            errorMessage.innerHTML += '<span>O email não é válido.<br></span>';
            validacoesCorretas--;
        }
    
        if (senha.length < 8) {
            errorMessage.innerHTML += '<span>A senha deve ter pelo menos 8 caracteres. <br></span>';
            validacoesCorretas--;
        }

        if (senha !== repetirSenha) {
            errorMessage.innerHTML += '<span>As senhas não coincidem.<br></span>';
            validacoesCorretas--;
        }
        if (qtdUsuariosPlano <= qtdUsuarios) {
            errorMessage.innerHTML += '<span>A quantidade máxima de usuários do plano foi atingida. <br></span>';
            validacoesCorretas--;
        }

        if(validacoesCorretas == 5){
            fetch(`/usuario/editarUsuario/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nome: nome,
                    email: email,
                    senha: senha,
                    tipoUser: tipoUser
                })
            })
            .then(function (resposta) {
                if (resposta.ok) {
                    window.location = "/usuario"
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                alert("Erro no banco");
            });
        }

    }

    // Criar novo usuário
    saveUser.addEventListener('click', function () {
        const qtdUsuariosPlano = sessionStorage.QTD_USUARIOS_PLANO;
        const nome = document.getElementById('ipt_nome').value;
        const email = document.getElementById('ipt_email').value;
        const senha = document.getElementById('ipt_senha').value;
        const repetirSenha = document.getElementById('ipt_repetir_senha').value;
        const tipoUser = document.getElementById('slct_tipo_user').value;


        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const nomeRegex = /\d/;
        let validacoesCorretas = 5;

        const errorMessage = document.querySelector('.erromensagem');
        erromensagem.innerHTML = '';
        

        if (nome == "") {
            erromensagem.innerHTML += '<span>O nome é obrigatório.</span>';
            validacoesCorretas--;
        }
           
        if (email == "") {
            erromensagem.innerHTML += '<span>O email é obrigatório.</span>';
            validacoesCorretas--;
        } else if (!emailRegex.test(email)) {
            erromensagem.innerHTML += '<span>O email não é válido.</span>';
            validacoesCorretas--;
        }
    
        if (senha.length < 8) {
            erromensagem.innerHTML += '<span>A senha deve ter pelo menos 8 caracteres.</span>';
            validacoesCorretas--;
        }

        if (senha !== repetirSenha) {
            erromensagem.innerHTML += '<span>As senhas não coincidem.</span>';
            validacoesCorretas--;
        }
        if (qtdUsuariosPlano <= qtdUsuarios) {
            erromensagem.innerHTML += '<span>A quantidade máxima de usuários do plano foi atingida.</span>';
            validacoesCorretas--;
        }

        
        if (validacoesCorretas == 5) {
            fetch("/usuario/criarUsuario", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nome_user: nome,
                    email_user: email,
                    senha_user: senha,
                    tipo_user: tipoUser,
                    fk_empresa: sessionStorage.FK_EMPRESA
                }),
            })
                .then(function (resposta) {
                    if (resposta.ok) {
                        window.location = "/usuario"
                    }
                }).catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                    alert("Erro no banco");
                });
        }
   })


    
    //Deletar Usuário
    function deletarUsuario(idUser){
        fetch(`/usuario/deletarUsuario/${idUser}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta){
            if (resposta.ok){
                window.location = "/usuario";
            } else if (resposta.status == 404){
                console.log("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        })
    }




</script>